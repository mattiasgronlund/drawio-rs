#!/usr/bin/env python3
from __future__ import annotations

import argparse
import csv
from pathlib import Path
from xml.etree import ElementTree as ET


def find_first_path(root: ET.Element) -> ET.Element | None:
    for elem in root.iter():
        tag = elem.tag
        if tag.endswith("path"):
            return elem
    return None


def main() -> int:
    parser = argparse.ArgumentParser(
        description="Augment variants.csv with path attributes from SVG exports."
    )
    parser.add_argument(
        "variants_csv", type=Path, help="CSV generated by edge_style_sweep.py"
    )
    parser.add_argument(
        "--svg-dir",
        type=Path,
        default=Path("tmp/edge-style-sweep/svg"),
        help="Directory containing SVG exports",
    )
    parser.add_argument(
        "--out",
        type=Path,
        help="Output CSV path (defaults to overwriting variants_csv)",
    )
    args = parser.parse_args()

    with args.variants_csv.open("r", newline="") as csv_file:
        reader = csv.DictReader(csv_file)
        rows = list(reader)
        fieldnames = list(reader.fieldnames or [])

    attr_names: set[str] = set()
    path_attrs_by_file: dict[str, dict[str, str]] = {}
    for row in rows:
        drawio_path = Path(row.get("file", ""))
        svg_path = args.svg_dir / f"{drawio_path.stem}.svg"
        if not svg_path.exists():
            path_attrs_by_file[row.get("file", "")] = {}
            continue
        try:
            tree = ET.parse(svg_path)
        except ET.ParseError:
            path_attrs_by_file[row.get("file", "")] = {}
            continue
        path_elem = find_first_path(tree.getroot())
        if path_elem is None:
            path_attrs_by_file[row.get("file", "")] = {}
            continue
        attrs = dict(path_elem.attrib)
        path_attrs_by_file[row.get("file", "")] = attrs
        attr_names.update(attrs.keys())

    ordered_attrs = sorted(attr_names)
    for name in ordered_attrs:
        if name not in fieldnames:
            fieldnames.append(name)

    out_path = args.out or args.variants_csv
    with out_path.open("w", newline="") as csv_file:
        writer = csv.DictWriter(csv_file, fieldnames=fieldnames)
        writer.writeheader()
        for row in rows:
            attrs = path_attrs_by_file.get(row.get("file", ""), {})
            for name in ordered_attrs:
                row[name] = attrs.get(name, "")
            writer.writerow(row)

    print(f"wrote {out_path}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
